<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault - Upload</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="p-6 md:p-12">

    <div class="max-w-2xl mx-auto animate">
        <div class="flex items-center justify-between mb-12">
            <button onclick="location.href='dash.html'" class="flex items-center gap-2 text-gray-500 hover:text-white transition-all text-xs font-bold uppercase tracking-widest">
                <i data-lucide="chevron-left" size="16"></i> Retour
            </button>
            <h1 class="text-xl font-black italic">ULTRA<span class="text-blue-600">SAFE</span></h1>
        </div>

        <div class="glass p-8 md:p-16 text-center border-dashed border-2 border-white/10 hover:border-blue-500/50 transition-all group" id="dropZone">
            <div class="mb-8">
                <div class="w-20 h-20 bg-blue-600/10 text-blue-500 rounded-3xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-500">
                    <i data-lucide="upload-cloud" size="40"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Déposer un fichier</h2>
                <p class="text-gray-500 text-sm">Glissez-déposez ou cliquez pour parcourir vos dossiers</p>
                <p class="text-[10px] text-gray-600 mt-4 uppercase tracking-tighter">Vitesse bridée à 500 Mo/s pour la sécurité</p>
            </div>

            <input type="file" id="fileInput" class="hidden">
            <button onclick="document.getElementById('fileInput').click()" class="btn-primary">
                SÉLECTIONNER UN FICHIER
            </button>

            <div id="uploadStatus" class="hidden mt-12 space-y-4">
                <div class="flex justify-between text-xs font-bold uppercase tracking-widest text-gray-400">
                    <span id="fileNameDisplay">Fichier...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="h-2 w-full bg-black rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-600 w-0 transition-all duration-300 shadow-[0_0_15px_rgba(37,99,235,0.5)]"></div>
                </div>
                <p id="msg" class="text-[10px] text-blue-400 animate-pulse italic">Chiffrement et transfert en cours...</p>
            </div>
        </div>

        <div class="mt-8 glass p-6 flex items-center gap-4 border-blue-500/10">
            <i data-lucide="shield-check" class="text-blue-500"></i>
            <p class="text-xs text-gray-400 leading-relaxed">
                Tous les fichiers sont analysés et isolés dans votre partition personnelle. 
                Le serveur rejette automatiquement tout fichier dépassant votre quota actuel.
            </p>
        </div>
    </div>

    <script>
        // Initialisation des icônes
        lucide.createIcons();

        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const API_URL = "http://localhost:3000"; // À remplacer par ton URL Ngrok si besoin

        // Gestion du Drag & Drop
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-blue-500'); };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]);
        };

        fileInput.onchange = () => {
            if (fileInput.files.length) handleUpload(fileInput.files[0]);
        };

        async function handleUpload(file) {
            const token = localStorage.getItem('token');
            if (!token) return alert("Session expirée. Reconnectez-vous.");

            const formData = new FormData();
            formData.append('file', file);

            // Affichage de la barre
            document.getElementById('uploadStatus').classList.remove('hidden');
            document.getElementById('fileNameDisplay').innerText = file.name;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', `${API_URL}/upload`, true);
            xhr.setRequestHeader('Authorization', token);

            // Suivi de progression réelle
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('percentText').innerText = percent + '%';
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    document.getElementById('msg').innerText = "TRANSFERT RÉUSSI ! Redirection...";
                    document.getElementById('msg').classList.remove('text-blue-400');
                    document.getElementById('msg').classList.add('text-green-500');
                    setTimeout(() => location.href = 'manage.html', 1500);
                } else if (xhr.status === 413) {
                    alert("ERREUR : Quota de stockage dépassé !");
                    location.reload();
                } else {
                    alert("Erreur serveur lors de l'envoi.");
                    location.reload();
                }
            };

            xhr.onerror = () => alert("Erreur de connexion au serveur.");
            xhr.send(formData);
        }
    </script>
</body>
</html>
